<!--
Based sample: https://gist.github.com/1071227

Mac: /Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome --disable-web-security --allow-file-access-from-files --allow-file-access --user-data-dir=~/chrome-test/
-->
<!DOCTYPE html>
<html lang="ja">

<head>
	<meta charset="utf-8">
	<title>jsHaiku</title>
	<style type="text/css">
<!--
#keyword { width:300px; }
#status  {
	width :300px;
	height:150px;
}
-->
	</style>

</head>

<body>
<h1>jsHaiku</h1>
キーワード:<br>
<input name="keyword" value="" id="keyword" placeholder="お題 (省略可能)"><br>
本文:<br>
<textarea name="status" id="status" placeholder="本文"></textarea><br>
<input type="button" value="Haiku!" onClick="haiku(getElementById('keyword').value,getElementById('status').value)">

<br><br><input type="button" onClick="localStorage.clear();" value="Clear Pin">

<script type="text/javascript" src="jsOAuth-1.3.4.js"></script>
<script type="text/javascript" src="config.js"></script>
<script type="text/javascript">

var oauth = OAuth(options);

var pin = localStorage['pin'] || "";
//var AccessToken = localStorage['token'] || "";
//var AccessTokenSecret = localStorage['tokenSecret'] || "";
console.log("pin = "+pin);
//console.log("Token = "+AccessToken);
//console.log("Secret = "+AccessTokenSecret);

	oauth.setAccessToken('', '');
	var url = oauth.authorizationUrl;
	oauth.request({
		'url': oauth.requestTokenUrl,
		'callbackUrl': "oob",
		'data':{
			'scope':'read_public,write_public'
		},
		'success': function (data) {
			var token = oauth.parseTokenRequest(data, data.responseHeaders['Content-Type'] || undefined);
			oauth.setAccessToken([token.oauth_token, token.oauth_token_secret]);
if (pin == "") {
			openAuthoriseWindow(url + '?' + data.text);
} else {
			console.log(oauth.getVerifier());
			oauth.setVerifier(pin);
			oauth.fetchAccessToken(getSomeData, failureHandler);
}
		},
		'failure': failureHandler
	});

function openAuthoriseWindow(url)
{
	var wnd = window.open(url, 'authorise');
	setTimeout(waitForPin, 100);

	function waitForPin()
	{
		if (wnd.closed) {
			pin = prompt("Please enter your PIN", "");
			oauth.setVerifier(pin);
			oauth.fetchAccessToken(getSomeData, failureHandler);
			localStorage['pin'] = oauth.getVerifier();
	//		localStorage['token'] = oauth.getAccessTokenKey();
	//		localStorage['tokenSecret'] = oauth.getAccessTokenSecret();
		} else {
			setTimeout(waitForPin, 100);
		}
	}
}

function getSomeData()
{
	oauth.get("http://h.hatena.ne.jp/api/statuses/friends_timeline.json", function (data) {
		console.log(data.text);
	}, failureHandler);
}

function failureHandler(data)
{
	console.error(data);
}

function haiku(keyword,body)
{
	var data = {
		'status'  : body,
		'source'  : 'jsHaiku'
	};
	oauth.post('http://h.hatena.ne.jp/api/statuses/update.json', data, haikuSuccess, haikuFailed);
}

function haikuSuccess() {
	alert("Haikuuuuuuu!");
}
function haikuFailed() {
	alert("Uh…");
}

</script>
</body>
</html>